name: cimxml-ci

on:
  pull_request:
    paths:
      - "cimxml/**"
      - ".github/workflows/cimxml-ci.yml"
      - ".github/workflows/cimxml-release.yml"
  push:
    paths:
      - "cimxml/**"
      - ".github/workflows/cimxml-ci.yml"
      - ".github/workflows/cimxml-release.yml"

permissions:
  contents: read

concurrency:
  group: cimxml-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Java 21
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          cache-dependency-path: cimxml/pom.xml

      - name: Build and test
        run: mvn -B -ntp -f cimxml/pom.xml clean verify

  publish-snapshot-github-packages:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: build-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Java 21 for GitHub Packages
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          cache-dependency-path: cimxml/pom.xml
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN

      - name: Enforce snapshot version on main
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(mvn -q -f cimxml/pom.xml help:evaluate -Dexpression=project.version -DforceStdout)"
          if [[ "${VERSION}" != *-SNAPSHOT ]]; then
            echo "Expected cimxml version to end with -SNAPSHOT on main, found: ${VERSION}" >&2
            exit 1
          fi

      - name: Deploy snapshot to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mvn -B -ntp -f cimxml/pom.xml clean deploy \
            -DaltDeploymentRepository=github::https://maven.pkg.github.com/${{ github.repository }}
