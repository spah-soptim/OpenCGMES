name: cimxml-release

on:
  push:
    tags:
      - "cimxml-v*.*.*"

permissions:
  contents: read

concurrency:
  group: cimxml-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate-tag:
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.validate.outputs.release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate release tag and pom version
        id: validate
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          if [[ ! "${TAG}" =~ ^cimxml-v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "Invalid tag format '${TAG}'. Expected cimxml-vX.Y.Z" >&2
            exit 1
          fi

          RELEASE_VERSION="${TAG#cimxml-v}"
          POM_VERSION="$(mvn -q -f cimxml/pom.xml help:evaluate -Dexpression=project.version -DforceStdout)"
          POM_BASE="${POM_VERSION%-SNAPSHOT}"

          if [[ "${POM_BASE}" != "${RELEASE_VERSION}" ]]; then
            echo "Tag version '${RELEASE_VERSION}' does not match pom base version '${POM_BASE}' (pom=${POM_VERSION})" >&2
            exit 1
          fi

          echo "release_version=${RELEASE_VERSION}" >> "${GITHUB_OUTPUT}"

  publish-maven-central:
    needs: validate-tag
    runs-on: ubuntu-latest
    env:
      CENTRAL_PORTAL_USERNAME: ${{ secrets.CENTRAL_PORTAL_USERNAME }}
      CENTRAL_PORTAL_PASSWORD: ${{ secrets.CENTRAL_PORTAL_PASSWORD }}
      MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
      RELEASE_VERSION: ${{ needs.validate-tag.outputs.release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          [[ -n "${CENTRAL_PORTAL_USERNAME}" ]] || (echo "CENTRAL_PORTAL_USERNAME is missing" >&2; exit 1)
          [[ -n "${CENTRAL_PORTAL_PASSWORD}" ]] || (echo "CENTRAL_PORTAL_PASSWORD is missing" >&2; exit 1)
          [[ -n "${MAVEN_GPG_PASSPHRASE}" ]] || (echo "MAVEN_GPG_PASSPHRASE is missing" >&2; exit 1)

      - name: Setup Java 21 + Maven Central auth + GPG
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          cache-dependency-path: cimxml/pom.xml
          server-id: central
          server-username: CENTRAL_PORTAL_USERNAME
          server-password: CENTRAL_PORTAL_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Set release version in CI workspace
        run: |
          mvn -B -ntp -f cimxml/pom.xml \
            org.codehaus.mojo:versions-maven-plugin:2.21.0:set \
            -DnewVersion="${RELEASE_VERSION}" \
            -DgenerateBackupPoms=false

      - name: Publish to Maven Central
        run: mvn -B -ntp -f cimxml/pom.xml -Pcentral-release clean deploy

  publish-github-packages-release:
    needs:
      - validate-tag
      - publish-maven-central
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      RELEASE_VERSION: ${{ needs.validate-tag.outputs.release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Java 21 for GitHub Packages
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          cache-dependency-path: cimxml/pom.xml
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN

      - name: Set release version in CI workspace
        run: |
          mvn -B -ntp -f cimxml/pom.xml \
            org.codehaus.mojo:versions-maven-plugin:2.21.0:set \
            -DnewVersion="${RELEASE_VERSION}" \
            -DgenerateBackupPoms=false

      - name: Publish release to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mvn -B -ntp -f cimxml/pom.xml -DskipTests clean deploy \
            -DaltDeploymentRepository=github::https://maven.pkg.github.com/${{ github.repository }}
